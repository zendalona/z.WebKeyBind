// Global Translation Dictionary
window.translations = {
    English: {
        settingsTitle: "z.WebKeyBind Settings",
        defaultTitle: "Default Shortcuts",
        savedTitle: "Saved Shortcuts",
        addBtn: "Add Shortcut",
        showAll: "Show all Shortcuts",
        showCurrent: "Show Current Site Only",
        deleteAll: "Delete Shortcuts",
        def_row1: "Open or Close Settings Window",
        def_row2: "Use Keyboard to Focus & Record",
        def_row3: "Use Mouse to Hover & Record",
        def_row4: "Read all Shortcuts",
        p_url: "Website URL",
        p_name: "Action Name",
        p_id: "Element ID / Class",
        p_key: "Key",
        no_shortcuts: "No shortcuts found for",
        delete_confirm: "Delete this shortcut?",
        delete_all_confirm: "Delete all visible shortcuts?",
        conflictMsg: "Please use another Key. This key '{key}' is already used for '{button}'.",
        importBtn: "Import Shortcuts",
        exportBtn: "Export Site Shortcuts",
        exportAllBtn: "Export All Shortcuts",
        importSuccess: "Imported {count} shortcuts successfully.",
        importInvalid: "Invalid JSON file.",
        importTypeErr: "Please use a .json file.",
        importTitle: "Import Shortcuts",
        dragDropText: "Drag & Drop .json file here",
        browseText: "or click to browse",
        cancelBtn: "Close",
        menuLabel: "Menu",
        duplicate_error: "The key '{key}' is already saved for this button: {name}"
    },
    हिंदी: {
        settingsTitle: "z.WebKeyBind सेटिंग्स",
        defaultTitle: "डिफ़ॉल्ट शॉर्टकट",
        savedTitle: "सहेजे गए शॉर्टकट",
        addBtn: "शॉर्टकट जोड़ें",
        showAll: "सभी शॉर्टकट देखें",
        showCurrent: "केवल वर्तमान साइट",
        deleteAll: "शॉर्टकट हटाएं",
        def_row1: "सेटिंग्स विंडो खोलें या बंद करें",
        def_row2: "रिकॉर्ड करने के लिए कीबोर्ड का उपयोग करें",
        def_row3: "रिकॉर्ड करने के लिए माउस का उपयोग करें",
        def_row4: "सभी शॉर्टकट पढ़ें",
        p_url: "वेबसाइट URL",
        p_name: "क्रिया का नाम",
        p_id: "तत्व ID (Element ID)",
        p_key: "कूंजी",
        no_shortcuts: "इसके लिए कोई शॉर्टकट नहीं मिला:",
        delete_confirm: "क्या आप इस शॉर्टकट को हटाना चाहते हैं?",
        delete_all_confirm: "क्या आप सभी दिखाई देने वाले शॉर्टकट हटाना चाहते हैं?",
        conflictMsg: "कृपया दूसरी कुंजी का उपयोग करें। यह कुंजी '{key}' पहले से ही '{button}' के लिए उपयोग की गई है।",
        importBtn: "आयात करें",
        exportBtn: "साइट निर्यात करें",
        exportAllBtn: "सभी निर्यात करें",
        importSuccess: "{count} शॉर्टकट सफलतापूर्वक आयात किए गए।",
        importInvalid: "अमान्य JSON फ़ाइल।",
        importTypeErr: "कृपया .json फ़ाइल का उपयोग करें।",
        importTitle: "शॉर्टकट आयात करें",
        dragDropText: ".json फ़ाइल को यहाँ ड्रैग और ड्रॉप करें",
        browseText: "या ब्राउज़ करने के लिए क्लिक करें",
        cancelBtn: "बंद करें",
        menuLabel: "मेन्यू",
        duplicate_error: "कुंजी '{key}' पहले से ही इस बटन के लिए सहेजी गई है: {name}"

    },
    मराठी: {
        settingsTitle: "z.WebKeyBind सेटिंग्स",
        defaultTitle: "डीफॉल्ट शॉर्टकट",
        savedTitle: "जतन केलेले शॉर्टकट",
        addBtn: "शॉर्टकट जोडा",
        showAll: "सर्व शॉर्टकट पहा",
        showCurrent: "फक्त वर्तमान साइट",
        deleteAll: "शॉर्टकट हटवा",
        def_row1: "सेटिंग्ज विंडो उघडा किंवा बंद करा",
        def_row2: "रेकॉर्ड करण्यासाठी कीबोर्ड वापरा",
        def_row3: "रेकॉर्ड करण्यासाठी माऊस वापरा",
        def_row4: "सर्व शॉर्टकट वाचा",
        p_url: "संकेतस्थळ URL",
        p_name: "क्रियेचे नाव",
        p_id: "एलिमेंट ID",
        p_key: "कळ (Key)",
        no_shortcuts: "यासाठी शॉर्टकट सापडले नाहीत:",
        delete_confirm: "हा शॉर्टकट हटवायचा का?",
        delete_all_confirm: "तुम्हाला नक्की सर्व शॉर्टकट हटवायचे आहेत का?",
        conflictMsg: "कृपया दुसरी कळ वापरा. ही कळ '{key}' आधीच '{button}' साठी वापरली गेली आहे।",
        importBtn: "आयात करा",
        exportBtn: "साइट निर्यात करा",
        exportAllBtn: "सर्व निर्यात करा",
        importSuccess: "{count} शॉर्टकट यशस्वीपणे आयात केले.",
        importInvalid: "अवैध JSON फाइल.",
        importTypeErr: "कृपया .json फाइल वापरा.",
        importTitle: "शॉर्टकट आयात करा",
        dragDropText: ".json फाइल येथे ड्रॅग आणि ड्रॉप करा",
        browseText: "किंवा ब्राउझ करण्यासाठी क्लिक करा",
        cancelBtn: "बंद करा",
        menuLabel: "मेनू",
        duplicate_error: "ही की '{key}' या बटणासाठी आधीच सेव्ह केली आहे: {name}"

    },
    മലയാളം: {
        settingsTitle: "z.WebKeyBind ക്രമീകരണങ്ങൾ",
        defaultTitle: "സ്ഥിരസ്ഥിതി കുറുക്കുവഴികൾ",
        savedTitle: "സൂക്ഷിച്ച കുറുക്കുവഴികൾ",
        addBtn: "കുറുക്കുവഴി ചേർക്കുക",
        showAll: "എല്ലാ കുറുക്കുവഴികളും",
        showCurrent: "ഈ സൈറ്റിൽ മാത്രം",
        deleteAll: "കുറുക്കുവഴികൾ നീക്കം ചെയ്യുക",
        def_row1: "ക്രമീകരണ ജാലകം തുറക്കുക/അടയ്ക്കുക",
        def_row2: "റെക്കോർഡ് ചെയ്യാൻ കീബോർഡ് ഉപയോഗിക്കുക",
        def_row3: "റെക്കോർഡ് ചെയ്യാൻ മൗസ് ഉപയോഗിക്കുക",
        def_row4: "എല്ലാ കുറുക്കുവഴികളും വായിക്കുക",
        p_url: "വെബ്സൈറ്റ് URL",
        p_name: "പ്രവർത്തനത്തിന്റെ പേര്",
        p_id: "എലമെന്റ് ID",
        p_key: "കീ",
        no_shortcuts: "കുറുക്കുവഴികളൊന്നും കണ്ടെത്തിയില്ല:",
        delete_confirm: "ഈ കുറുക്കുവഴി നീക്കം ചെയ്യണോ?",
        delete_all_confirm: "എല്ലാ കുറുക്കുവഴികളും നീക്കം ചെയ്യണോ?",
        conflictMsg: "ദയവായി മറ്റൊരു കീ ഉപയോഗിക്കുക. ഈ കീ '{key}' ഇതിനകം '{button}' എന്നതിനായി ഉപയോഗിച്ചു.",
        importBtn: "ഇമ്പോർട്ട്",
        exportBtn: "സൈറ്റ് എക്സ്‌പോർട്ട്",
        exportAllBtn: "എല്ലാം എക്സ്‌പോർട്ട്",
        importSuccess: "{count} കുറുക്കുവഴികൾ വിജയകരമായി ഇമ്പോർട്ട് ചെയ്തു.",
        importInvalid: "അസാധുവായ JSON ഫയൽ.",
        importTypeErr: "ദയവായി ഒരു .json ഫയൽ ഉപയോഗിക്കുക.",
        importTitle: "കുറുക്കുവഴികൾ ഇമ്പോർട്ട് ചെയ്യുക",
        dragDropText: ".json ഫയൽ ഇവിടെ ഡ്രാഗ് ചെയ്ത് ഡ്രോപ്പ് ചെയ്യുക",
        browseText: "അല്ലെങ്കിൽ ബ്രൗസ് ചെയ്യാൻ ക്ലിക്ക് ചെയ്യുക",
        cancelBtn: "അടയ്ക്കുക",
        menuLabel: "മെനു",
        duplicate_error: "ഈ കീ '{key}' ഈ ബട്ടണിനായി ഇതിനകം സേവ് ചെയ്തിട്ടുണ്ട്: {name}"
    }
};

window.currentLang = "English"; 

window.updateLanguageUI = function(lang) {
    window.currentLang = lang; 
    const t = window.translations[lang];
    
    // --- 1. Header & Titles ---
    document.getElementById('current-lang').innerText = lang;
    document.querySelector('.logo').innerText = t.settingsTitle;
    const titles = document.querySelectorAll('.section-title');
    if(titles.length >= 2) {
        titles[0].innerText = t.defaultTitle;
        titles[1].innerText = t.savedTitle;
    }

    // --- 2. Menu Buttons (Import/Export) ---
    const btnImport = document.getElementById('btn-import');
    const btnExportSite = document.getElementById('btn-export-site');
    const btnExportAll = document.getElementById('btn-export-all');
    if (btnImport) btnImport.innerText = t.importBtn;
    if (btnExportSite) btnExportSite.innerText = t.exportBtn;
    if (btnExportAll) btnExportAll.innerText = t.exportAllBtn;

    // --- 3. Modal Content ---
    const modalTitle = document.querySelector('.modal-content h3');
    const dropMainText = document.querySelector('#drop-zone p:not(.sub-text)');
    const dropSubText = document.querySelector('.sub-text');
    const closeBtn = document.getElementById('btn-close-import');

    if (modalTitle) modalTitle.innerText = t.importTitle;
    if (dropMainText) dropMainText.innerHTML = t.dragDropText.replace('.json', '<b>.json</b>');
    if (dropSubText) dropSubText.innerText = t.browseText;
    if (closeBtn) closeBtn.innerText = t.cancelBtn;

    // --- 4. Main Buttons ---
    const btnAdd = document.querySelector('.btn-add');
    const btnDeleteAll = document.querySelector('.btn-delete-all');
    if (btnAdd) btnAdd.innerHTML = `<span class="plus">+</span> ${t.addBtn}`;
    if (btnDeleteAll) btnDeleteAll.innerText = t.deleteAll;

    const burger = document.getElementById('burger-label');
    if (burger) burger.setAttribute('aria-label', t.menuLabel);

    // --- 5. Language Dropdown Active State ---
    document.querySelectorAll('.dropdown-item').forEach(item => {
        if(item.getAttribute('data-lang') === lang) {
            item.classList.add('active');
            item.querySelector('.check').style.opacity = '1';
        } else {
            item.classList.remove('active');
            item.querySelector('.check').style.opacity = '0';
        }
    });
    
    // --- 6. Default Table ---
    const rows = document.querySelectorAll('.default-table tbody tr');
    if(rows.length >= 4) {
        rows[0].cells[0].innerText = t.def_row1;
        rows[1].cells[0].innerText = t.def_row2;
        rows[2].cells[0].innerText = t.def_row3;
        rows[3].cells[0].innerText = t.def_row4;
    }

    // --- 7. Set HTML Lang for NVDA ---
    const langMap = { "English": "en", "हिंदी": "hi", "मराठी": "mr", "മലയാളം": "ml" };
    document.documentElement.lang = langMap[lang] || "en";
};

// Event Listeners for Language Dropdown
document.addEventListener('DOMContentLoaded', () => {
    const langTrigger = document.querySelector('.dropdown-trigger');
    const langMenu = document.getElementById('lang-menu');
    
    // 1. TOGGLE MENU
    langTrigger.addEventListener('click', (e) => {
        const isOpen = langMenu.style.display === 'block';
        langMenu.style.display = isOpen ? 'none' : 'block';
        langTrigger.setAttribute('aria-expanded', !isOpen);
        e.stopPropagation();
    });

    // 2. ITEM SELECTION
    document.querySelectorAll('.dropdown-item').forEach(item => {
        item.setAttribute('tabindex', '0');

        const handleSelect = (e) => {
            const selectedLang = item.getAttribute('data-lang');
            chrome.storage.local.set({ 'ui_language': selectedLang });
            window.updateLanguageUI(selectedLang);
            if (window.loadShortcuts) window.loadShortcuts();
            langMenu.style.display = 'none';
            langTrigger.setAttribute('aria-expanded', 'false');
            e.stopPropagation();
        };
        item.addEventListener('click', handleSelect);
        item.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleSelect(e);
            }
        });
    });

    document.addEventListener('click', () => {
        if(langMenu) langMenu.style.display = 'none';
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && langMenu.style.display === 'block') {
            langMenu.style.display = 'none';
            langTrigger.focus(); 
        }
    });
});